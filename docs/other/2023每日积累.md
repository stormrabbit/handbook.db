# 2023 每日积累整理

## [2023-01-03] 统计当前使用者git项目提交代码行数命令问题

### 基本命令

```
git log --since="2022-01-01" --before="2023-01-01" --author="$(git config --get user.name)" --pretty=tformat: --numstat | awk '{ add += $1 ; subs += $2 ; loc += $1 + $2 } END { printf "added lines: %s removed lines : %s total lines: %s\n",add,subs,loc }'
```

### 拓展：改为接受命令行执行 sh

```
# test.sh
# sh test.sh 2022-01-01 2023-01-01
start=$1
end=$2
author="$(git config --get user.name)"

echo "开始日期: ${start}"
echo "结束日期: ${end}"
echo "git user: ${author}"

git log --since="${start}" --before="${end}" --author="$(git config --get user.name)" --pretty=tformat: --numstat | awk '{ add += $1 ; subs += $2 ; loc1 += $1 - $2 ;loc2 += $1 + $2 } END { printf "新增: %s，删除: %s，净增: %s，总计修改: %s\n",add,subs,loc1,loc2 }'
```

#### 小问题

命令最开始使用的是 `gawk`，使用时报错 ` command not found: gawk`，更换为 `awk` 则成功运行。

## [2023-01-04] 有关设置服务器定时任务的构想与步骤拆解

> 买了服务器不知道干啥用，想想怎么能有效把服务器利用起来。

### 步骤

1. 编写简单的脚本 `demo.sh`，脚本内容为：`df -h`。
2. 获取运行结果，保存成文件 `demo-res.txt`。[参考](https://blog.csdn.net/weixin_38370441/article/details/115487340)
   - 每次输出内容如果相同，用日期 `date` 进行简单区分。 
   - sh 日期格式化：`date "+%Y-%m-%d %H:%M:%S"`（注意需要使用 "" 将格式化文本包起来，留有空格会被认为是 2 个命令而报错）。[参考](https://cloud.tencent.com/developer/article/1720961)
3. 使用电子邮件发送 `demo-res.txt`。
   - linux 下通常使用 mailx 发送邮件。
   - mailx 命令：`echo "This is the mail body" | mail -s "Subject" 123@qq.com`
   - mail -s "Hello from jsdig.com by shell" 123@qq.com
   - echo "hello,this is the content of mail.welcome to www.jsdig.com" | mail -s "Hello from jsdig.com by pipe" 123@qq.com
   - 卡住了，走不下去。
4. 定时每天 11 点发送。
   - 使用 linux 常用命令 crontab，一般自带。
     - crontab 是否存在：`rpm -qa | grep crontab`。
     - crontab 是否在运行：`systemctl status crond`，`active (running)` 表示在运行，`inactive (dead)` 表示未运行。
     - crontab 启动：`systemctl start crond` 。
     - [其余常用命令](https://zhuanlan.zhihu.com/p/115082330)。
   - crontab [常用写法](https://www.runoob.com/w3cnote/linux-crontab-tasks.html)。
   - crontab [未正常运行原因参考](https://blog.csdn.net/u011734144/article/details/54576469)。
     - 练手过程中遇到的是路径问题，crontab 实际上是运行了的，但是因为 sh 脚本中 `> demo-res.txt` 是相对路径，所以写入到了 crontab 目录下的 `demo-res.txt`，修改为绝对路径则正常运行。
   - crontab 运行后的其他问题：
     - 有关 `crontab -e` 和 `crontab /etc/crontab` 执行问题：经测试两者分别独立，`crontab -e` 为当前用户计划，不需要也不能指定用户（会报错）；`crontab /etc/crontab` 为总体定时计划，需要指定用户。
     - 运行 `demo.sh` 脚本后会莫名其妙的收到邮件，命令行提示 `You have new mail`。进入 `/etc/mail` 目录下发现 `demo.sh` 脚本的输出结果被输出到了`运行用户名`命名的文件内，原因不明。

#### sh 脚本

```
date "+%Y-%m-%d %H:%M:%S"> demo-res.txt
df -h >> demo-res.txt
cat demo-res.txt
```

#### 后续扩展思考

1. 服务器可以执行哪些脚本？
2. 可以执行的是否只有脚本？
3. 如何定时爬取 steam 打折游戏列表？
4. 以日常维护来说，服务器需要哪些定时任务？
5. 其他项目是否需要定时任务？

#### 好文参考

- [Crontab 定时任务](https://my.oschina.net/u/4313887/blog/3710661)
- [云服务器定时任务方案cron（全流程）](https://juejin.cn/post/6913131133597122568)
- [linux 常用命令](http://mcos.top/archives/linux-chang-yong-ming-ling--wen-jian-cao-zuo--ding-shi-ren-wu--cha-kan-fu-wu-qi-xin-xi-)